<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paseo Testing Suite</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #00ff88;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .login-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #00ff88;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #fff;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff8800, #ff6600);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none !important;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
        }

        .card h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-connected {
            background: #00ff88;
            color: #000;
        }

        .status-disconnected {
            background: #ff4444;
            color: #fff;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #888;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .log {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #666;
            font-weight: bold;
        }

        .log-info { color: #00ff88; }
        .log-error { color: #ff4444; }
        .log-warning { color: #ff8800; }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .range-group {
            margin-bottom: 15px;
        }

        .range-group label {
            display: block;
            margin-bottom: 8px;
            color: #00ff88;
        }

        .range-slider {
            width: 100%;
            margin-bottom: 5px;
        }

        .range-value {
            text-align: center;
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Paseo Testing Suite</h1>
            <p>Professional Blockchain Stress Testing</p>
        </div>

        <!-- Login Panel -->
        <div id="loginPanel" class="panel">
            <form class="login-form" onsubmit="return false;">
                <div class="form-group">
                    <label for="privateKey">Private Key</label>
                    <input type="password" id="privateKey" placeholder="0x..." required>
                </div>
                
                <div class="form-group">
                    <label for="rpcUrl">RPC URL</label>
                    <input type="text" id="rpcUrl" value="https://testnet-passet-hub-eth-rpc.polkadot.io" required>
                </div>
                
                <div style="text-align: center;">
                    <button type="button" class="btn btn-primary" onclick="connect()">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                    <button type="button" class="btn btn-warning" onclick="testRPC()">
                        <i class="fas fa-wifi"></i> Test RPC
                    </button>
                </div>
                
                <div id="connectionStatus" style="text-align: center; margin-top: 20px;"></div>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Header Bar -->
            <div class="header-bar">
                <div>
                    <span class="status status-connected" id="statusIndicator">‚óè Connected</span>
                    <span style="margin-left: 20px;">Wallet: <span id="walletAddress">-</span></span>
                </div>
                <button class="btn btn-danger" onclick="disconnect()">
                    <i class="fas fa-sign-out-alt"></i> Disconnect
                </button>
            </div>

            <!-- Stats -->
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="childContracts">0</div>
                    <div class="stat-label">Child Contracts</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalTx">0</div>
                    <div class="stat-label">Total TX</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="currentBlock">0</div>
                    <div class="stat-label">Block</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="gasPrice">--</div>
                    <div class="stat-label">Gas (gwei)</div>
                </div>
            </div>

            <!-- Main Dashboard Grid -->
            <div class="dashboard">
                <div class="card">
                    <h3><i class="fas fa-cube"></i> Contract Management</h3>
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="createContracts()">Create 10 Contracts</button>
                        <button class="btn btn-warning" onclick="createTokens()">Create Tokens</button>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-bolt"></i> Stress Testing</h3>
                    <div class="range-group">
                        <label>Intensity: <span id="intensityValue">50</span>%</label>
                        <input type="range" class="range-slider" id="intensity" min="1" max="100" value="50" oninput="updateIntensity(this.value)">
                    </div>
                    <div class="control-group">
                        <button class="btn btn-warning" onclick="startStressTest()">Start Test</button>
                        <button class="btn btn-danger" onclick="stopTest()">Stop Test</button>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-rocket"></i> Load Testing</h3>
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="executeLoadTest()">Load Test (100 TX)</button>
                        <button class="btn btn-warning" onclick="distributedTest()">Distributed Test</button>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-chart-bar"></i> Actions</h3>
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="refreshStats()">Refresh</button>
                        <button class="btn btn-warning" onclick="emergencyStop()">Emergency Stop</button>
                    </div>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="panel" style="margin-top: 20px;">
                <h3><i class="fas fa-terminal"></i> Console</h3>
                <div class="log" id="logArea">
                    <div class="log-entry">
                        <span class="log-time">[00:00:00]</span>
                        <span class="log-info">System ready</span>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="clearLog()">Clear</button>
                    <button class="btn btn-warning" onclick="exportLog()">Export</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contracts
        const TESTING_SUITE_ADDRESS = "0x7a637dc8cbfb49edc55fbe97fab0b0824c163605";
        const TOKEN_FACTORY_ADDRESS = "0x39ca236cb8131f6748d3862bb574f24a10e1c38d";

        // State
        let provider = null;
        let wallet = null;
        let testingSuite = null;
        let tokenFactory = null;
        let isTestRunning = false;

        // ABIs
        const testingSuiteABI = [
            "function createChildren(uint256 count)",
            "function startTest(uint256 intensity)",
            "function executeLoadTest(uint256 txCount)",
            "function executeDistributedTest()",
            "function stopTest()",
            "function getStats() view returns (uint256 children, uint256 txs, uint256 currentBlock, uint256 blocksElapsed, bool active)",
            "function childContractCount() view returns (uint256)",
            "function totalTransactions() view returns (uint256)"
        ];

        const tokenFactoryABI = [
            "function createTestTokens(uint256 count)",
            "function distributeTokens(address token, address[] memory recipients)",
            "function getTokenCount() view returns (uint256)"
        ];

        // Logging
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Connection Functions
        async function testRPC() {
            const rpcUrl = document.getElementById('rpcUrl').value.trim();
            if (!rpcUrl) {
                log('‚ùå Enter RPC URL first', 'error');
                return;
            }

            try {
                log('üåê Testing RPC...', 'info');
                const testProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                const block = await testProvider.getBlockNumber();
                log(`‚úÖ RPC OK - Block ${block}`, 'info');
            } catch (error) {
                log(`‚ùå RPC Failed: ${error.message}`, 'error');
            }
        }

        async function connect() {
            const privateKey = document.getElementById('privateKey').value.trim();
            const rpcUrl = document.getElementById('rpcUrl').value.trim();

            if (!privateKey || !rpcUrl) {
                log('‚ùå Fill all fields', 'error');
                return;
            }

            try {
                log('üîå Connecting...', 'info');

                // Format private key
                let key = privateKey;
                if (!key.startsWith('0x')) {
                    key = '0x' + key;
                }

                // Create provider and wallet
                provider = new ethers.providers.JsonRpcProvider(rpcUrl, {
                    chainId: 420420422,
                    name: 'paseo-testnet'
                });

                wallet = new ethers.Wallet(key, provider);

                // Test connection
                const balance = await wallet.getBalance();
                const blockNumber = await provider.getBlockNumber();

                log(`‚úÖ Connected! Address: ${wallet.address}`, 'info');
                log(`üí∞ Balance: ${ethers.utils.formatEther(balance)} PAS`, 'info');
                log(`üì¶ Block: ${blockNumber}`, 'info');

                // Initialize contracts
                testingSuite = new ethers.Contract(TESTING_SUITE_ADDRESS, testingSuiteABI, wallet);
                tokenFactory = new ethers.Contract(TOKEN_FACTORY_ADDRESS, tokenFactoryABI, wallet);

                // Update UI
                document.getElementById('walletAddress').textContent = wallet.address;
                document.getElementById('loginPanel').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

                // Initial refresh
                await refreshStats();

            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        function disconnect() {
            provider = null;
            wallet = null;
            testingSuite = null;
            tokenFactory = null;
            
            document.getElementById('loginPanel').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            
            log('üîå Disconnected', 'warning');
        }

        // Contract Functions
        async function createContracts() {
            if (!testingSuite) {
                log('‚ùå Not connected', 'error');
                return;
            }

            try {
                log('üèóÔ∏è Creating contracts...', 'info');
                const tx = await testingSuite.createChildren(10);
                log(`üì§ TX: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                log(`‚úÖ Created contracts in block ${receipt.blockNumber}`, 'success');
                
                await refreshStats();
            } catch (error) {
                log(`‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function createTokens() {
            if (!tokenFactory) {
                log('‚ùå Not connected', 'error');
                return;
            }

            try {
                log('ü™ô Creating tokens...', 'info');
                const tx = await tokenFactory.createTestTokens(5);
                log(`üì§ TX: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                log(`‚úÖ Created tokens in block ${receipt.blockNumber}`, 'success');
            } catch (error) {
                log(`‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function startStressTest() {
            if (!testingSuite) {
                log('‚ùå Not connected', 'error');
                return;
            }

            try {
                const intensity = document.getElementById('intensity').value;
                log(`‚ö° Starting stress test at ${intensity}%`, 'info');
                
                const tx = await testingSuite.startTest(intensity);
                await tx.wait();
                
                isTestRunning = true;
                log('‚úÖ Stress test started', 'success');
            } catch (error) {
                log(`‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function stopTest() {
            if (!testingSuite) {
                log('‚ùå Not connected', 'error');
                return;
            }

            try {
                const tx = await testingSuite.stopTest();
                await tx.wait();
                
                isTestRunning = false;
                log('üõë Test stopped', 'warning');
            } catch (error) {
                log(`‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function executeLoadTest() {
            if (!testingSuite) {
                log('‚ùå Not connected', 'error');
                return;
            }

            try {
                log('üöÄ Executing load test...', 'info');
                const tx = await testingSuite.executeLoadTest(100);
                log(`üì§ TX: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                log(`‚úÖ Load test completed - Gas: ${receipt.gasUsed}`, 'success');
                
                await refreshStats();
            } catch (error) {
                log(`‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function distributedTest() {
            if (!testingSuite) {
                log('‚ùå Not connected', 'error');
                return;
            }

            try {
                log('üåê Running distributed test...', 'info');
                const tx = await testingSuite.executeDistributedTest();
                await tx.wait();
                
                log('‚úÖ Distributed test completed', 'success');
                await refreshStats();
            } catch (error) {
                log(`‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function emergencyStop() {
            log('üö® EMERGENCY STOP', 'error');
            if (testingSuite) {
                await stopTest();
            }
        }

        // Utility Functions
        function updateIntensity(value) {
            document.getElementById('intensityValue').textContent = value;
        }

        async function refreshStats() {
            if (!testingSuite) return;

            try {
                const stats = await testingSuite.getStats();
                const childCount = await testingSuite.childContractCount();
                const totalTx = await testingSuite.totalTransactions();
                
                document.getElementById('childContracts').textContent = childCount.toString();
                document.getElementById('totalTx').textContent = totalTx.toString();
                document.getElementById('currentBlock').textContent = stats.currentBlock.toString();
                
                // Get gas price
                const gasPrice = await provider.getGasPrice();
                const gasInGwei = ethers.utils.formatUnits(gasPrice, 'gwei');
                document.getElementById('gasPrice').textContent = gasInGwei;
                
            } catch (error) {
                log(`‚ùå Stats failed: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '<div class="log-entry"><span class="log-time">[' + new Date().toLocaleTimeString() + ']</span> <span class="log-info">Console cleared</span></div>';
        }

        function exportLog() {
            const logContent = document.getElementById('logArea').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `paseo-log-${Date.now()}.txt`;
            a.click();
            log('üìÑ Log exported', 'info');
        }

        // Auto-refresh stats
        setInterval(() => {
            if (wallet && testingSuite) {
                refreshStats();
            }
        }, 3000);
    </script>
</body>
</html>