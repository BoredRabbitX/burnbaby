<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>TERMINAL_BURN_V3_PASEO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --neon: #00ff41; --burn: #ff003c; --dim: #003b00; --bg: #050505; }
        body { background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; }
        #terminal { display: flex; flex-direction: column; height: 100vh; padding: 20px; box-sizing: border-box; border: 3px solid var(--neon); }
        .header { text-shadow: 0 0 10px var(--neon); border-bottom: 2px solid var(--neon); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; font-weight: bold; }
        
        .grid { display: grid; grid-template-columns: 450px 1fr; gap: 20px; flex-grow: 1; min-height: 0; }
        
        .panel { border: 1px solid var(--neon); padding: 15px; background: rgba(0, 255, 65, 0.03); display: flex; flex-direction: column; }
        
        /* Contatori */
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { border: 1px solid var(--dim); padding: 10px; text-align: center; }
        .stat-card.mint { border-color: var(--neon); box-shadow: inset 0 0 10px rgba(0,255,65,0.2); }
        .stat-card.burn { border-color: var(--burn); box-shadow: inset 0 0 10px rgba(255,0,60,0.2); color: var(--burn); }
        .counter { font-size: 32px; font-weight: bold; display: block; margin-top: 5px; color: #fff; }

        input { background: #000; border: 1px solid var(--dim); color: #fff; width: 100%; padding: 10px; margin-bottom: 10px; outline: none; box-sizing: border-box; }
        button { background: var(--neon); color: black; border: none; padding: 18px; width: 100%; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 16px; box-shadow: 0 0 15px var(--dim); }
        button:hover { background: #fff; box-shadow: 0 0 25px var(--neon); }
        
        #console { background: #000; border: 1px solid var(--dim); height: 100%; overflow-y: auto; padding: 10px; font-size: 11px; color: var(--neon); border-radius: 4px; }
        .log-mint { color: var(--neon); border-left: 2px solid var(--neon); padding-left: 5px; margin: 2px 0; }
        .log-burn { color: var(--burn); border-left: 2px solid var(--burn); padding-left: 5px; margin: 2px 0; font-weight: bold; }
    </style>
</head>
<body>

<div id="terminal">
    <div class="header">
        <span>RUNNING: BURN_PROTOCOL_ASSETHUB_PASEO</span>
        <span id="clock">00:00:00</span>
    </div>

    <div class="grid">
        <div class="panel">
            <div class="stats-container">
                <div class="stat-card mint">
                    MINTED
                    <span id="mintCount" class="counter">0</span>
                </div>
                <div class="stat-card burn">
                    BURNED
                    <span id="burnCount" class="counter">0</span>
                </div>
            </div>

            <div style="font-size: 18px; margin-bottom: 20px; border-bottom: 1px solid var(--dim);">
                CURRENT BALANCE: <span id="balDisp" style="color:#fff">0.00</span> BURN
            </div>

            <label style="font-size: 10px; color: #555;">RPC PROVIDER</label>
            <input type="text" id="rpcUrl" value="https://testnet-passet-hub-eth-rpc.polkadot.io">
            
            <label style="font-size: 10px; color: #555;">ACCESS KEY</label>
            <input type="password" id="privKey" value="e7b0f8447fb5c168c7f2f33e30ed2377aef70a71546c58e4cc3690e62769df12">
            
            <label style="font-size: 10px; color: #555;">SMART CONTRACT</label>
            <input type="text" id="contractAddr" value="0x459739728d2FAfE3Bc23e507B703304DdF7ab102">
            
            <button id="startBtn">INITIATE AUTO-SEQUENCE</button>
            <p id="statusDisp" style="text-align:center; font-size: 12px; margin-top: 10px; color: #555;">STATUS: IDLE</p>
        </div>

        <div class="panel">
            <div id="console">> TERMINAL_OS_v3.0 READY...</div>
        </div>
    </div>
</div>

<script>
    let totalMinted = 0;
    let totalBurned = 0;
    
    const abi = [
        "function trigger() public",
        "function balanceOf(address) view returns (uint256)",
        "event Transfer(address indexed from, address indexed to, uint256 value)"
    ];

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

    const log = (msg, type = "") => {
        const c = document.getElementById('console');
        const div = document.createElement('div');
        div.className = type === "mint" ? "log-mint" : (type === "burn" ? "log-burn" : "");
        div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
        c.prepend(div);
    };

    document.getElementById('startBtn').onclick = async () => {
        const rpc = document.getElementById('rpcUrl').value;
        const key = document.getElementById('privKey').value;
        const addr = document.getElementById('contractAddr').value;

        try {
            const provider = new ethers.JsonRpcProvider(rpc);
            const wallet = new ethers.Wallet(key, provider);
            const contract = new ethers.Contract(addr, abi, wallet);

            document.getElementById('statusDisp').innerText = "SEQUENCE_ACTIVE";
            document.getElementById('statusDisp').style.color = "var(--neon)";
            log("PROTOCOLLO AVVIATO. ASCOLTO EVENTI ON-CHAIN...", "mint");

            // ASCOLTO EVENTI MINT E BURN IN TEMPO REALE
            contract.on("Transfer", (from, to, value) => {
                const amount = parseFloat(ethers.formatEther(value));
                if (from === "0x0000000000000000000000000000000000000000") {
                    totalMinted += amount;
                    document.getElementById('mintCount').innerText = totalMinted.toFixed(0);
                    log(`+++ MINT RILEVATO: +${amount} BURN`, "mint");
                } else if (to === "0x0000000000000000000000000000000000000000") {
                    totalBurned += amount;
                    document.getElementById('burnCount').innerText = totalBurned.toFixed(0);
                    log(`--- BURN RILEVATO: -${amount} BURN`, "burn");
                }
            });

            runLoop(contract, wallet, provider);
        } catch (e) {
            log("INIT_ERROR: " + e.message, "burn");
        }
    };

    async function runLoop(contract, wallet, provider) {
        while (true) {
            try {
                const nonce = await provider.getTransactionCount(wallet.address, "latest");
                log(`INVIO TRIGGER [NONCE: ${nonce}]...`);
                
                const tx = await contract.trigger({
                    nonce: nonce,
                    gasLimit: 350000
                });

                log(`TX BROADCAST: ${tx.hash.substring(0,20)}...`);
                await tx.wait();
                
                const bal = await contract.balanceOf(wallet.address);
                document.getElementById('balDisp').innerText = ethers.formatEther(bal);
                log("CONFERMATO. ATTESA COOLDOWN.");
            } catch (e) {
                log("COOLDOWN_ACTIVE: Attendi il minuto successivo.");
            }
            await new Promise(r => setTimeout(r, 61000));
        }
    }
</script>
</body>
</html>
